{% extends "layout.html" %}

{% block title %}{{ detect_type | capitalize }} Detection{% endblock %}

{% block content %}
<div class="detect-container">

    <h2>{{ detect_type | capitalize }} Detection Live Feed</h2>
    <p class="sub-heading">
        Model: {{ detect_type.capitalize() }} Model (YOLOv8) | Input: Live Webcam Feed
    </p>

    <div class="detect-body">

        <div class="detect-video-main">
            <div class="video-container">
                <img id="video-feed" src="{{ url_for('video_feed', detect_type=detect_type) }}" class="video-feed" alt="Live video feed">
                <canvas id="roi-canvas"></canvas>
            </div>
        </div>

        <div class="detect-sidebar">
            <button id="enable-audio-btn" class="btn btn-secondary">
                Click to Enable Alert Sound
            </button>
            <div class="roi-buttons">
                <button id="draw-roi-btn" class="btn">Draw ROI</button>
                <button id="clear-roi-btn" class="btn btn-danger">Clear ROI</button>
            </div>
            <div id="alert-box" class="alert-box">
                <h3 id="alert-title">Detection Status</h3>
                <p id="alert-message">System is monitoring... No alerts.</p>
            </div>
        </div>

    </div>

    

</div>

<audio id="alert-beep"
       src="{{ url_for('static', filename='audio/alert.mp3', v=cache_v) }}"
       preload="auto">
</audio>
{% endblock %}


{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {

        console.log("HTML page is fully loaded. Running script.");

        // Get elements
        const alertBox = document.getElementById('alert-box');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const beepSound = document.getElementById('alert-beep');
        const audioBtn = document.getElementById('enable-audio-btn');
        const videoFeed = document.getElementById('video-feed');
        const canvas = document.getElementById('roi-canvas');
        const drawRoiBtn = document.getElementById('draw-roi-btn');
        const clearRoiBtn = document.getElementById('clear-roi-btn');
        const ctx = canvas.getContext('2d');

        let audioEnabled = false;
        let isSoundOnCooldown = false;
        let isVisualAlertActive = false;
        let roiRect = null;
        let isDrawing = false;
        let startX, startY;
        let currentRoiVisual = null;

        if (!alertBox || !alertTitle || !alertMessage || !beepSound || !audioBtn || !videoFeed || !canvas || !drawRoiBtn || !clearRoiBtn) {
            console.error("CRITICAL ERROR: Could not find one or more required elements.");
            return;
        }

        beepSound.volume = 1.0;

        // --- Canvas & ROI Functions ---
        function resizeCanvas() {
            setTimeout(() => {
                const videoRect = videoFeed.getBoundingClientRect();
                canvas.width = videoRect.width;
                canvas.height = videoRect.height;
                drawROI();
            }, 100);
        }

        function drawROI() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (currentRoiVisual) {
                ctx.strokeStyle = 'lime';
                ctx.lineWidth = 2;
                ctx.strokeRect(currentRoiVisual.x, currentRoiVisual.y, currentRoiVisual.w, currentRoiVisual.h);
            }
        }

        // --- Audio Button Setup ---
        audioBtn.addEventListener('click', function() {
            beepSound.volume = 1.0;
             if (!beepSound.src || beepSound.src === window.location.href) {
                console.error("Audio source invalid or missing. Attempting to reload...");
                beepSound.src = "{{ url_for('static', filename='audio/alert.mp3', v=cache_v) }}";
            }
            beepSound.play().then(() => {
                audioEnabled = true;
                beepSound.pause();
                beepSound.currentTime = 0;
                audioBtn.style.backgroundColor = '#2a9d8f'; // Success color
                audioBtn.innerText = 'Sound Enabled';
                console.log("Audio successfully unlocked by user click.");
            }).catch(e => {
                console.error("Audio unlock failed:", e);
            });
        });

        console.log("Required elements found. Connecting to SocketIO...");

        // --- SocketIO Connection ---
        var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port, {
            transports: ['websocket']
        });

        socket.on('connect', function() {
            console.log("SocketIO connected successfully!");
            resizeCanvas();
        });

        // --- ROI Button Listeners ---
        drawRoiBtn.addEventListener('click', () => {
             clearRoiBtn.click();
             console.log("Draw ROI mode active. Click and drag on video.");
        });

        clearRoiBtn.addEventListener('click', () => {
            roiRect = null;
            currentRoiVisual = null;
            drawROI();
            socket.emit('clear_roi');
            console.log("ROI Cleared.");
        });

        // --- Canvas Mouse Event Listeners ---
        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
             drawROI();
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            drawROI();
            ctx.strokeStyle = 'yellow';
            ctx.lineWidth = 1;
            ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
        });

        canvas.addEventListener('mouseup', (e) => {
            if (!isDrawing) return;
            isDrawing = false;
            const rect = canvas.getBoundingClientRect();
            const endX = e.clientX - rect.left;
            const endY = e.clientY - rect.top;

            const x = Math.min(startX, endX);
            const y = Math.min(startY, endY);
            const w = Math.abs(startX - endX);
            const h = Math.abs(startY - endY);
            currentRoiVisual = { x, y, w, h };

            const roiX1 = x / canvas.width;
            const roiY1 = y / canvas.height;
            const roiX2 = (x + w) / canvas.width;
            const roiY2 = (y + h) / canvas.height;

            roiRect = [roiX1, roiY1, roiX2, roiY2];
            socket.emit('set_roi', { roi: roiRect });

            drawROI();
            console.log("ROI Drawn and Sent:", roiRect);
        });

        // --- Resize Listeners ---
        window.addEventListener('resize', resizeCanvas);
        videoFeed.addEventListener('load', resizeCanvas);


        // --- Alert Handling ---
        socket.on('detection_alert', function(data) {

            if (!isVisualAlertActive) {
                console.log("RECEIVED ALERT FROM SERVER:", data.message);
            }

            // Sound Cooldown
            if (audioEnabled && !isSoundOnCooldown) {
                isSoundOnCooldown = true;
                beepSound.currentTime = 0;
                var playPromise = beepSound.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.error("!!! AUDIO PLAYBACK FAILED !!!", error);
                    });
                }
                setTimeout(() => { isSoundOnCooldown = false; }, 3000);
            }

            // Visual Cooldown
            if (isVisualAlertActive) return;
            isVisualAlertActive = true;

            // Show Visual Alert
            alertBox.classList.add('alert-active');
            alertTitle.innerText = "!!! ALERT !!!";
            alertMessage.innerText = data.message;

            // Reset Visual Alert
            setTimeout(() => {
                alertBox.classList.remove('alert-active');
                alertTitle.innerText = "Detection Status";
                alertMessage.innerText = "System is monitoring... No alerts.";
                isVisualAlertActive = false;
            }, 3000);
        });

        socket.on('connect_error', function(err) {
            console.error("SocketIO connection error:", err);
        });

    });
</script>
{% endblock %}